function replaceImageWhenLoaded(imageObject, thumb) {
  setTimeout( function () {
    if (!imageObject.complete) {
      replaceImageWhenLoaded(imageObject, thumb);
    }
    else {
      thumb.parentElement.replaceChild(imageObject, thumb);
    }
  }, 100);
}

//loadGalleryImages creates a DOM image object for each entry in the filename matrix given as a parameter. It assigns each object appropriate attributes, finds its thumbnail counterpart, and passes both to the replaceImageWhenLoaded function.
function loadGalleryImages(galleryFilenames) {
  var galleryIndex = 0;
  for (var rowIndex = 0; rowIndex < galleryFilenames.length; rowIndex ++) {
    for (var colIndex = 0; colIndex < galleryFilenames[rowIndex].length; colIndex ++) {
      var filename = galleryFilenames[rowIndex][colIndex];
      var imageObject = document.createElement("IMG");
      imageObject.setAttribute("src", "images/<%= config[:GALLERY_FOLDER] %>/" + filename);
      
      var thumb = document.getElementById("galleryIndex" + galleryIndex);
      imageObject.setAttribute("width", thumb.width);
      imageObject.setAttribute("height", thumb.height);
      replaceImageWhenLoaded(imageObject, thumb);
      imageObject.addEventListener("click", function (event) { openOverlay(event) });
      
      gallery.push(imageObject);
      thumbs.push(thumb); //extraneous?
      galleryIndex += 1;
    }
  }
}

function openOverlay(event) {
  galleryOverlayDiv.style.zIndex = "1";
  galleryOverlayDiv.style.animationFillMode = "forwards";
  galleryOverlayDiv.style.animationDuration = ".5s";
  galleryOverlayDiv.style.animationName = "overlay-fadein";

  var overlayImage = event.target.cloneNode();

  var navBarHeight = 100;
  var widthRatio = overlayImage.naturalWidth / galleryOverlayDiv.offsetWidth;
  var heightRatio = overlayImage.naturalHeight / (window.innerHeight - navBarHeight);
  var scaleRatio = 1;
  if (widthRatio > heightRatio) {
    scaleRatio = 1 / widthRatio;
  }
  else {
    scaleRatio = 1 / heightRatio;
  }
  if (scaleRatio > 1) {
    scaleRatio = 1;
  }

  var imageWidth = overlayImage.naturalWidth * scaleRatio;
  var imageHeight = overlayImage.naturalHeight * scaleRatio;
  var marginTop = ((window.innerHeight - navBarHeight) - imageHeight) / 2;

  overlayImage.setAttribute("width", imageWidth);
  overlayImage.setAttribute("height", imageHeight);
  overlayImage.style.marginTop = marginTop.toString() + "px";

  overlayImage.addEventListener("click", function () { closeOverlay() });

  galleryOverlayDiv.appendChild(overlayImage);
}

function closeOverlay() {
  galleryOverlayDiv.innerHTML = "";
  galleryOverlayDiv.style.animationFillMode = "forwards";
  galleryOverlayDiv.style.animationDuration = ".5s";
  galleryOverlayDiv.style.animationName = "overlay-fadeout";
  setTimeout( function () { galleryOverlayDiv.style.zIndex = "-1"; }, 500);
}

gallery = [];
thumbs = []; //extraneous?
galleryOverlayDiv = null;

var galleryFilenames = [ //assemble matrix of filenames from middleman config variable (same as  
  <% config[:gallery].each do |row| %>
  [
    <% row.each do |filename| %>
      "<%= filename %>",
    <% end %>
  ],
  <% end %>
];

//This is where the script begins to interact with the page
window.onload = function () { //Wait for window to load
  galleryOverlayDiv = document.getElementById("gallery-overlay-div");
  window.document.body.onload = loadGalleryImages(galleryFilenames); //Wait for body to load, then call function to load gallery images
}
